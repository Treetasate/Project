import streamlit as st
import pandas as pd
from functools import reduce 
import plotly.express as px

file_path = "Data/Thesis.csv"

def load_data():
    data = pd.read_csv(file_path)
    data.fillna("", inplace=True)
    data = data.astype(str)
    return data

data = load_data()

# Initialize session state for checkboxes if not already done
for advisor in data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].unique():
    if advisor not in st.session_state:
        st.session_state[advisor] = True

for project_type in data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].unique():
    if project_type not in st.session_state:
        st.session_state[project_type] = True

for year in data['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].unique():
    if year not in st.session_state:
        st.session_state[year] = True

st.title("üìâ Dashboard from CED üìà")

st.header("")
col1, col2, col3 = st.columns(3)

# Advisor filter
with col1:
    advisor_expander = st.expander("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤")
    selected_advisors = []
    if advisor_expander.button("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", key='select_all_advisors'):
        for advisor in data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].unique():
            st.session_state[advisor] = True
    if advisor_expander.button("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", key='reset_advisors'):
        for advisor in data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].unique():
            st.session_state[advisor] = False
    for advisor in data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].unique():
        is_checked = advisor_expander.checkbox(advisor, value=st.session_state[advisor])
        st.session_state[advisor] = is_checked
        if is_checked:
            selected_advisors.append(advisor)

# Project type filter
with col2:
    type_expander = st.expander("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ")
    selected_types = []
    if type_expander.button("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", key='select_all_types'):
        for project_type in data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].unique():
            st.session_state[project_type] = True
    if type_expander.button("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", key='reset_types'):
        for project_type in data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].unique():
            st.session_state[project_type] = False
    for project_type in data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].unique():
        is_checked = type_expander.checkbox(project_type, value=st.session_state[project_type])
        st.session_state[project_type] = is_checked
        if is_checked:
            selected_types.append(project_type)

# Year filter
with col3:
    year_expander = st.expander("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤")
    selected_years = []
    if year_expander.button("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", key='select_all_years'):
        for year in sorted(data['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].unique(), key=lambda x: int(x)):
            st.session_state[year] = True
    if year_expander.button("‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å", key='reset_years'):
        for year in sorted(data['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].unique(), key=lambda x: int(x)):
            st.session_state[year] = False
    for year in sorted(data['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].unique(), key=lambda x: int(x)):
        is_checked = year_expander.checkbox(year, value=st.session_state[year])
        st.session_state[year] = is_checked
        if is_checked:
            selected_years.append(year)

# Apply filtering based on selection
conditions = []
if selected_advisors:
    conditions.append(data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].isin(selected_advisors))
if selected_types:
    conditions.append(data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].isin(selected_types))
if selected_years:
    conditions.append(data['‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤'].isin(selected_years))

if conditions:
    filtered_data = data.loc[reduce(lambda x, y: x & y, conditions)]
else:
    filtered_data = data.copy()

# Displaying totals
st.header("")
col1, col2, col3 = st.columns(3)
with col1:
    st.markdown(f"<div class='big-font green-font'>‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : {filtered_data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].nunique()}</div>", unsafe_allow_html=True)
with col2:
    st.markdown(f"<div class='big-font red-font'>‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : {filtered_data.shape[0]}</div>", unsafe_allow_html=True)
with col3:
    st.markdown(f"<div class='big-font blue-font'>‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î : {filtered_data['‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ó‡∏≥1'].nunique()}</div>", unsafe_allow_html=True)

st.title("")
st.dataframe(filtered_data)  # You can use st.table(filtered_data) if no interactivity is needed

# Creating a bar chart for the project types
project_type_counts = filtered_data['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ'].value_counts().reset_index()
project_type_counts.columns = ['‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ', 'Count']
fig_bar = px.bar(project_type_counts, x='‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ', y='Count', title='Distribution of Project Types')
st.plotly_chart(fig_bar)

# Creating a pie chart for the advisors
advisor_counts = filtered_data['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤'].value_counts().reset_index()
advisor_counts.columns = ['‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤', 'Count']
fig_pie = px.pie(advisor_counts, values='Count', names='‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤', title='Distribution of Projects by Advisor')
st.plotly_chart(fig_pie)
